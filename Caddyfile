# Caddyfile for AppSec Catalog
# 
# PRODUCTION: Replace 'yourdomain.com' with your actual domain
# Caddy will automatically obtain Let's Encrypt certificates
#
# LOCAL NETWORK: Use your local domain (e.g., appsec.local) with self-signed certificates

# Production configuration (HTTPS with Let's Encrypt)
# Uncomment and replace 'yourdomain.com' with your actual public domain
# yourdomain.com {
#     # Reverse proxy to frontend
#     handle / {
#         reverse_proxy frontend:3000 {
#             header_up Host {host}
#             header_up X-Real-IP {remote}
#             header_up X-Forwarded-For {remote}
#             header_up X-Forwarded-Proto {scheme}
#         }
#     }
# 
#     # Reverse proxy API requests to backend
#     handle /api/* {
#         reverse_proxy backend:3001 {
#             header_up Host {host}
#             header_up X-Real-IP {remote}
#             header_up X-Forwarded-For {remote}
#             header_up X-Forwarded-Proto {scheme}
#         }
#     }
# 
#     # Reverse proxy health check
#     handle /health {
#         reverse_proxy backend:3001
#     }
# }

# Local network configuration (HTTPS with self-signed certificates)
appsec.companynet.org {
    # Use self-signed certificate for local network
    tls internal

    # Reverse proxy API requests to backend (must come before /)
    handle /api/* {
        reverse_proxy backend:3001 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Reverse proxy health check
    handle /health {
        reverse_proxy backend:3001
    }

    # Explicitly handle static assets (JS, CSS, images, etc.)
    handle /assets/* {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Handle markdown files in docs directory (serve as static files)
    handle /docs/*.md {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Handle /docs routes (let React Router handle them - for the Docs component)
    handle /docs* {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Reverse proxy all other requests to frontend (must come last)
    handle {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}

# Alternative: HTTP only for local development (no HTTPS)
# Uncomment this block if you want HTTP only (no certificate warnings)
# :80 {
#     handle / {
#         reverse_proxy frontend:3000 {
#             header_up Host {host}
#             header_up X-Real-IP {remote}
#             header_up X-Forwarded-For {remote}
#             header_up X-Forwarded-Proto {scheme}
#         }
#     }
#     handle /api/* {
#         reverse_proxy backend:3001 {
#             header_up Host {host}
#             header_up X-Real-IP {remote}
#             header_up X-Forwarded-For {remote}
#             header_up X-Forwarded-Proto {scheme}
#         }
#     }
#     handle /health {
#         reverse_proxy backend:3001
#     }
# }

